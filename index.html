<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>RAIDERS ‚Äì Alue Map v2.1.2</title>
  <link rel="icon" type="image/png" href="Raiders.png">
  <style>
    body { margin: 0; background:#0a0a0a; color:#eee; font-family: sans-serif; overflow: hidden; }
    #info { 
      padding: 10px; background: #0A0000; position: fixed; top: 0; left: 0; right: 0; z-index: 10; 
      border-bottom: 2px solid #400000; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
      box-shadow: 0 4px 20px rgba(0,0,0,0.8);
    }
    .logo-container { display: flex; align-items: baseline; border-right: 2px solid #400000; padding-right: 15px; margin-right: 15px; }
    .logo { color: #ff0000; font-size: 26px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; font-style: italic; text-shadow: 0 0 10px rgba(255, 255, 255, 0.4), 2px 2px 2px #000; }
    .version-tag { color: #555; font-size: 10px; font-family: monospace; margin-left: 5px; font-weight: bold; }
    canvas { display: block; cursor: crosshair; image-rendering: pixelated; image-rendering: crisp-edges; }
    
    /* Admin-ty√∂kalujen piilotus, jos ei kirjauduttu */
    .admin-only { display: none !important; } 
    .is-admin .admin-only { display: flex !important; }
    
    .input-group, .point-box, #coords-display { background: #1a0000 !important; border: 1px solid #400000 !important; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; }
    input { background: #000; color: #00ff00; border: 1px solid #300000; width: 65px; padding: 4px; font-family: monospace; text-align: center; }
    button { background: #220000; color: white; border: 1px solid #500000; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-weight: bold; transition: all 0.2s; }
    button:hover { background: #400000; }
    
    #confirmAreaBtn { background: #1b5e20; border: 1px solid #2ecc71; color: white; }
    #gridMoveBtn.active, #markerToggle.active { background: #e67e22; color: #fff; border-color: white; box-shadow: 0 0 15px rgba(230, 126, 34, 0.6); }
    
    #markerTools { gap: 5px; background: #1a0000; padding: 5px; border-radius: 4px; border: 1px solid #444; display: none; align-items: center; }
    .m-tool { width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 3px; background: #333; border: 1px solid #444; font-size: 18px; }
    .m-tool.active { border-color: white; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
    #mGreen.active { background: #006400; }
    #mOrange.active { background: #FF8C00; }
    #mEraser.active { background: #e67e22; }

    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .login-card { background: #0A0000; padding: 30px; border-radius: 8px; border: 2px solid #400000; width: 320px; display: flex; flex-direction: column; gap: 15px; }
    .login-card input { width: 100%; box-sizing: border-box; padding: 10px; color: #fff; background: #000; border: 1px solid #400000; }
    
    #coords-display { color: #00ff00; font-size: 16px; font-weight: 800; padding: 4px 15px; font-family: 'Courier New', monospace; min-width: 180px; text-align: center; }
    .label-small { color: #a0a0a0; font-size: 9px; font-weight: bold; display: block; margin-bottom: 2px; text-transform: uppercase; letter-spacing: 1px; }
    .status-panel { margin-left: auto; display: flex; gap: 15px; align-items: center; }
    
    .color-picker { gap: 8px; border-left: 1px solid #400000; padding-left: 10px; }
    .swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #222; }
    .swatch.active { border-color: white; transform: scale(1.1); }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #400000; color: #fff; padding: 12px 25px; border-radius: 50px; z-index: 10000; display: none; border: 1px solid #f00; font-weight: bold; }
  </style>
</head>
<body id="mainBody">

<div id="loginOverlay">
    <div class="login-card">
        <h2>ADMIN LOGIN</h2>
        <div><span class="label-small">S√§hk√∂posti</span><input type="email" id="loginEmail" value="@raid.com"></div>
        <div><span class="label-small">Salasana</span><input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div style="display:flex; gap: 10px; margin-top:10px;">
            <button id="doLogin" style="flex: 2; background: #400000;">Kirjaudu</button>
            <button id="closeLogin" style="flex: 1;">Sulje</button>
        </div>
    </div>
</div>

<div id="toast"></div>
<div id="info">
  <div class="logo-container">
    <div class="logo">RAIDERS</div>
    <div class="version-tag">v2.1.2</div>
  </div>
  
  <button id="confirmAreaBtn" class="admin-only">‚úÖ Vahvista</button>
  <button id="gridMoveBtn" class="admin-only">‚ñ¶ Kohdista</button>
  
  <div class="admin-only input-group" style="padding: 4px 10px; align-items:center;">
    <span class="label-small">Ruudun koko</span>
    <input type="range" id="gridSizeSlider" min="5" max="150" value="25" style="width:80px;">
    <span id="gridSizeVal" style="color:#0f0; font-size:10px; font-family:monospace;">25px</span>
  </div>

  <button id="markerToggle" class="admin-only">üìç Marker</button>
  <div id="markerTools">
      <div class="m-tool active" id="mGreen" title="Vihre√§ Marker">üåø</div>
      <div class="m-tool" id="mOrange" title="Oranssi Marker">üî•</div>
      <div class="m-tool" id="mEraser" title="Poista">‚ùå</div>
  </div>
  
  <div id="adminTools" class="admin-only color-picker">
    <div class="swatch active" style="background: rgba(0, 255, 0, 0.5);" data-color="rgba(0, 255, 0, 0.5)"></div>
    <div class="swatch" style="background: rgba(255, 0, 0, 0.5);" data-color="rgba(255, 0, 0, 0.5)"></div>
    <div class="swatch" style="background: rgba(0, 150, 255, 0.5);" data-color="rgba(0, 150, 255, 0.5)"></div>
    <div class="swatch" style="background: #444; display:flex; align-items:center; justify-content:center; font-size:10px;" data-color="erase">‚ùå</div>
  </div>

  <div id="coords-display"><span class="label-small">Sijainti</span><span id="coords-val">---- , ----</span></div>
  
  <div class="admin-only input-group" style="padding: 4px 10px; flex-direction: row; gap: 8px;">
    <div style="display:flex; flex-direction:column; align-items:center;"><span class="label-small">Base X</span><input type="number" id="baseXInput" value="1700"></div>
    <div style="display:flex; flex-direction:column; align-items:center;"><span class="label-small">Base Y</span><input type="number" id="baseYInput" value="3700"></div>
    <button id="calBtn" title="Kalibroi">üîß</button>
  </div>

  <div class="status-panel">
    <div class="point-box"><span class="label-small">Hallinta</span><span id="areaPoints">0 aluetta</span></div>
    <button id="authBtn">Admin</button>
  </div>
</div>

<canvas id="map"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDNRDRwOQEnNDVeFIZe4no7wvOdHnpyfvY",
    authDomain: "hellcity-jengi-map.firebaseapp.com",
    projectId: "hellcity-jengi-map",
    databaseURL: "https://hellcity-jengi-map-default-rtdb.europe-west1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const dataRef = ref(db, 'live_map');

  const canvas = document.getElementById('map');
  const ctx = canvas.getContext('2d');

  let userLoggedIn = false, gridMoveMode = false, markerMode = false, markerEraser = false;
  let activeMarkerColor = "#006400", isDragging = false, isDraggingGrid = false;
  let capturedAreas = {}, freeMarkers = {}, gridOffset = { x: 0, y: 0 }, calAnchor = { gx: 0, gy: 0 };
  
  const tiles = [];
  const TILE_SIZE = 1024;
  let loadedTiles = 0, scale = 0.12, offsetX = 100, offsetY = 100, lastMouse = { x: 0, y: 0 };
  let selectedGrid = { gx: null, gy: null }, currentColor = "rgba(0, 255, 0, 0.5)", GRID_SIZE = 25; 

  // KARTTAPALAT
  for (let y = 0; y < 8; y++) {
    for (let x = 0; x < 8; x++) {
      const img = new Image();
      img.src = `gta_karttapalat/tile_${x}_${y}.png`;
      img.onload = () => { loadedTiles++; if(loadedTiles === 64) draw(); };
      tiles.push({ img, x, y });
    }
  }

  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.innerText = msg; toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 3000);
  }

  // --- ADMIN LOGIIKKA (LOGIN/ULOS) ---
  onAuthStateChanged(auth, u => { 
    userLoggedIn = !!u; 
    document.getElementById('mainBody').classList.toggle('is-admin', userLoggedIn); 
    document.getElementById('authBtn').innerText = u ? "Ulos" : "Admin";
  });

  document.getElementById('authBtn').onclick = () => { 
    if (userLoggedIn) { 
        if (confirm("Kirjaudu ulos?")) {
            signOut(auth).then(() => {
                showToast("Kirjauduttu ulos.");
                gridMoveMode = false; markerMode = false;
                document.getElementById('markerTools').style.display = 'none';
                draw();
            });
        }
    } else { document.getElementById('loginOverlay').style.display = 'flex'; }
  };

  document.getElementById('doLogin').onclick = () => { 
    const email = document.getElementById('loginEmail').value;
    const pass = document.getElementById('loginPass').value;
    signInWithEmailAndPassword(auth, email, pass)
      .then(() => { document.getElementById('loginOverlay').style.display = 'none'; showToast("Tervetuloa!"); })
      .catch(() => alert("Kirjautuminen ep√§onnistui."));
  };
  document.getElementById('closeLogin').onclick = () => document.getElementById('loginOverlay').style.display = 'none';

  // --- MARKERIT & TY√ñKALUT ---
  function updateMarkerUI(id) {
    document.querySelectorAll('.m-tool').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
  document.getElementById('mGreen').onclick = () => { markerEraser = false; activeMarkerColor = "#006400"; updateMarkerUI('mGreen'); };
  document.getElementById('mOrange').onclick = () => { markerEraser = false; activeMarkerColor = "#FF8C00"; updateMarkerUI('mOrange'); };
  document.getElementById('mEraser').onclick = () => { markerEraser = true; updateMarkerUI('mEraser'); };

  document.getElementById('markerToggle').onclick = () => {
    markerMode = !markerMode; gridMoveMode = false;
    document.getElementById('markerToggle').classList.toggle('active', markerMode);
    document.getElementById('gridMoveBtn').classList.remove('active');
    document.getElementById('markerTools').style.display = markerMode ? 'flex' : 'none';
    draw();
  };

  // --- RUUDUKON S√Ñ√ÑDIN ---
  const gridSizeSlider = document.getElementById('gridSizeSlider');
  const gridSizeVal = document.getElementById('gridSizeVal');
  gridSizeSlider.oninput = () => { GRID_SIZE = parseInt(gridSizeSlider.value); gridSizeVal.innerText = GRID_SIZE + "px"; draw(); };
  gridSizeSlider.onchange = () => { if(userLoggedIn) update(ref(db, 'live_map'), { current_grid_size: GRID_SIZE }); };

  // --- PIIRT√ÑMINEN ---
  function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save(); ctx.translate(offsetX, offsetY); ctx.scale(scale, scale);
    ctx.imageSmoothingEnabled = false;

    if (loadedTiles > 0) tiles.forEach(t => ctx.drawImage(t.img, t.x * TILE_SIZE, t.y * TILE_SIZE, TILE_SIZE + 0.5, TILE_SIZE + 0.5));

    const GAP = 0.5, DRAW_SIZE = GRID_SIZE - (GAP * 2);
    if (gridMoveMode) {
        ctx.beginPath(); ctx.strokeStyle = "rgba(255, 165, 0, 0.6)"; ctx.lineWidth = 1.5/scale;
        for (let x = 0; x <= 8192; x += GRID_SIZE) { ctx.moveTo(x + gridOffset.x, gridOffset.y); ctx.lineTo(x + gridOffset.x, 8192 + gridOffset.y); }
        for (let y = 0; y <= 8192; y += GRID_SIZE) { ctx.moveTo(gridOffset.x, y + gridOffset.y); ctx.lineTo(8192 + gridOffset.x, y + gridOffset.y); }
        ctx.stroke();
    }
    for (let key in capturedAreas) { 
        let [gx, gy] = key.split(',').map(Number); ctx.fillStyle = capturedAreas[key].color; 
        ctx.fillRect(gx * GRID_SIZE + gridOffset.x + GAP, gy * GRID_SIZE + gridOffset.y + GAP, DRAW_SIZE, DRAW_SIZE); 
    }
    for (let id in freeMarkers) { 
        ctx.fillStyle = freeMarkers[id].color || "#006400"; ctx.beginPath(); ctx.arc(freeMarkers[id].x, freeMarkers[id].y, 6/scale, 0, Math.PI*2); ctx.fill(); 
        ctx.strokeStyle = "white"; ctx.lineWidth = 1/scale; ctx.stroke(); 
    }
    if (selectedGrid.gx !== null && !gridMoveMode && !markerMode) { 
        ctx.strokeStyle = "#FFFFFF"; ctx.lineWidth = 3/scale; ctx.strokeRect(selectedGrid.gx * GRID_SIZE + gridOffset.x, selectedGrid.gy * GRID_SIZE + gridOffset.y, GRID_SIZE, GRID_SIZE); 
    }
    ctx.restore();
  }

  // --- HIIRI-TOIMINNOT ---
  canvas.addEventListener('mousedown', (e) => {
    const worldX = (e.clientX - offsetX) / scale, worldY = (e.clientY - offsetY) / scale;
    if (gridMoveMode && e.button === 0) { isDraggingGrid = true; lastMouse = { x: e.clientX, y: e.clientY }; return; }
    if (e.button === 2) { isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; return; }
    
    if (userLoggedIn && markerMode) {
        if (markerEraser) { 
            for (let id in freeMarkers) { if (Math.hypot(freeMarkers[id].x - worldX, freeMarkers[id].y - worldY) < 20/scale) { remove(ref(db, `live_map/free_markers/${id}`)); break; } } 
        } else { push(ref(db, 'live_map/free_markers'), { x: worldX, y: worldY, color: activeMarkerColor }); }
        return;
    }
    const gx = Math.floor((worldX - gridOffset.x) / GRID_SIZE), gy = Math.floor((worldY - gridOffset.y) / GRID_SIZE);
    selectedGrid = { gx, gy }; 
    const bX = parseInt(document.getElementById('baseXInput').value) || 0, bY = parseInt(document.getElementById('baseYInput').value) || 0;
    document.getElementById('coords-val').innerText = `${Math.round(bX + (gx - calAnchor.gx) * 100)} , ${Math.round(bY + (calAnchor.gy - gy) * 100)}`;
    draw();
  });

  window.onmousemove = (e) => { 
    if (isDraggingGrid) { gridOffset.x += (e.clientX - lastMouse.x) / scale; gridOffset.y += (e.clientY - lastMouse.y) / scale; lastMouse = { x: e.clientX, y: e.clientY }; draw(); }
    if (isDragging) { offsetX += e.clientX - lastMouse.x; offsetY += e.clientY - lastMouse.y; lastMouse = { x: e.clientX, y: e.clientY }; draw(); } 
  };
  window.onmouseup = () => { if (isDraggingGrid && userLoggedIn) update(ref(db, 'live_map'), { offset: gridOffset }); isDraggingGrid = isDragging = false; };
  canvas.onwheel = (e) => { e.preventDefault(); const z = e.deltaY < 0 ? 1.15 : 0.85; const wx = (e.clientX - offsetX) / scale, wy = (e.clientY - offsetY) / scale; scale *= z; scale = Math.min(Math.max(0.05, scale), 25); offsetX = e.clientX - wx * scale; offsetY = e.clientY - wy * scale; draw(); };

  // --- FIREBASE SYNKRONOINTI ---
  onValue(dataRef, (snapshot) => {
    const d = snapshot.val() || {};
    capturedAreas = d.areas || {}; freeMarkers = d.free_markers || {}; gridOffset = d.offset || {x:0,y:0}; calAnchor = d.anchor || {gx:0,gy:0};
    if(d.current_grid_size) { GRID_SIZE = d.current_grid_size; gridSizeSlider.value = GRID_SIZE; gridSizeVal.innerText = GRID_SIZE + "px"; }
    if(d.baseX!==undefined) document.getElementById('baseXInput').value = d.baseX;
    if(d.baseY!==undefined) document.getElementById('baseYInput').value = d.baseY;
    document.getElementById('areaPoints').innerText = `${Object.keys(capturedAreas).length} aluetta`;
    draw();
  });

  // --- MUUT NAPIT ---
  document.getElementById('gridMoveBtn').onclick = () => { gridMoveMode = !gridMoveMode; markerMode = false; document.getElementById('markerTools').style.display = 'none'; document.getElementById('gridMoveBtn').classList.toggle('active', gridMoveMode); document.getElementById('markerToggle').classList.remove('active'); draw(); };
  document.getElementById('confirmAreaBtn').onclick = () => { if (selectedGrid.gx !== null && userLoggedIn) { const key = `${selectedGrid.gx},${selectedGrid.gy}`; if (currentColor === "erase") remove(ref(db, `live_map/areas/${key}`)); else set(ref(db, `live_map/areas/${key}`), { color: currentColor }); } };
  document.getElementById('calBtn').onclick = () => { if (userLoggedIn && selectedGrid.gx !== null) update(ref(db, 'live_map'), { anchor: { gx: selectedGrid.gx, gy: selectedGrid.gy }, baseX: parseInt(document.getElementById('baseXInput').value), baseY: parseInt(document.getElementById('baseYInput').value) }).then(() => showToast("üîß Kalibroitu!")); };
  document.querySelectorAll('.swatch').forEach(s => s.onclick = () => { document.querySelectorAll('.swatch').forEach(w => w.classList.remove('active')); s.classList.add('active'); currentColor = s.dataset.color; });
  
  window.onresize = () => draw();
  canvas.oncontextmenu = (e) => e.preventDefault();
</script>
</body>
</html>