<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <title>RAIDERS ‚Äì Alue Map</title>
  <link rel="icon" type="image/png" href="Raiders.png">
  <style>
    body { margin: 0; background:#0a0a0a; color:#eee; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    #versionWarning { position: fixed; top: 65px; left: 0; right: 0; background: #ff0000; color: #fff; text-align: center; padding: 10px; font-weight: bold; z-index: 2000; display: none; box-shadow: 0 4px 15px rgba(255,0,0,0.5); border-bottom: 2px solid #fff; }
    #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 5000; display: none; }
    .login-card { background: #0d0000; border: 2px solid #600000; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 0 40px rgba(255, 0, 0, 0.3); }
    .login-card input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 4px; border: 1px solid #400000; background: #000; color: #0f0; outline: none; box-sizing: border-box; }
    .login-card button { width: 100%; padding: 12px; background: #600000; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
    #header { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: #000; border-bottom: 2px solid #400000; display: flex; align-items: center; padding: 0 20px; z-index: 1000; justify-content: space-between; }
    .logo { color: #ff0000; font-size: 26px; font-weight: 900; letter-spacing: 2px; }
    #adminSidePanel { position: fixed; top: 85px; right: 20px; width: 230px; background: rgba(10, 0, 0, 0.95); border: 1px solid #500000; padding: 15px; border-radius: 8px; z-index: 1000; display: none; flex-direction: column; gap: 12px; }
    .is-admin #adminSidePanel { display: flex; }
    .panel-section { border-bottom: 1px solid #300000; padding-bottom: 10px; }
    .section-title { color: #e67e22; font-size: 10px; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }
    .tool-btn { background: #220000; color: white; border: 1px solid #500000; padding: 10px; cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold; width: 100%; margin-bottom: 4px; }
    .tool-btn.active { background: #e67e22 !important; color: #000 !important; border-color: #fff !important; }
    .coord-input { width: 48%; padding: 5px; background: #000; border: 1px solid #555; color: #0f0; font-family: monospace; font-size: 12px; margin-bottom: 5px; }
    .swatch { width: 30px; height: 30px; border-radius: 4px; cursor: pointer; border: 1px solid #000; }
    .swatch.active { border: 2px solid white; box-shadow: 0 0 10px white; }
    #bottomLeftUI { position: fixed; bottom: 20px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .glass-box { background: rgba(0,0,0,0.85); border: 1px solid #400000; padding: 12px; border-radius: 8px; font-size: 12px; min-width: 160px; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
    .legend-title { color: #ff0000; font-weight: bold; border-bottom: 1px solid #333; margin-bottom: 5px; padding-bottom: 3px; display: block; }
    #toast { position: fixed; top: 85px; left: 50%; transform: translateX(-50%); background: #ff0000; color: #fff; padding: 10px 30px; border-radius: 50px; z-index: 10000; display: none; font-weight: bold; }
    canvas { display: block; cursor: crosshair; }
  </style>
</head>
<body id="mainBody">

<div id="versionWarning">‚ö†Ô∏è KARTASTA ON UUSI VERSIO! P√§ivit√§ sivu painamalla CTRL + F5 ‚ö†Ô∏è</div>
<div id="toast"></div>

<div id="bottomLeftUI">
    <div class="glass-box">
        <span class="legend-title">INFO</span>
        üåø = Kasvi paikka (Pysyv√§)<br>
        üî• = Kasvaa (14h laskuri)<br>
        ‚úÖ = Valmis ker√§tt√§v√§ksi<br>
        üçç = Ananas kasvaa <br>
        <hr style="border:0; border-top:1px solid #333; margin:5px 0;">
        <span style="color:#0f0; font-size:10px;">Vie hiiri p√§√§lle n√§hd√§ksesi kellonajat.</span>
    </div>
    <div class="glass-box" style="text-align:center; border-color: #0f0;">
        <span id="areaCount" style="color:#0f0; font-size:16px; font-weight:bold;">0</span><br>
        <span style="font-size:10px; letter-spacing:1px;">ALUETTA HALLUSSA</span>
    </div>
</div>

<div id="loginOverlay"><div class="login-card"><h2>ADMIN LOGIN</h2><input type="email" id="loginEmail" placeholder="S√§hk√∂posti" value="admin@raid.com"><input type="password" id="loginPass" placeholder="Salasana"><button id="doLogin">KIRJAUDU</button></div></div>
<div id="header">
    <div class="logo">RAIDERS <span style="font-size:10px; color:#444;" id="verLabel">v2.3.2</span></div>
    <div style="display:flex; gap:10px; align-items:center;">
        <div id="coords-val" style="font-family:monospace; color:#0f0; background:#111; padding:8px; border:1px solid #333; border-radius:4px; min-width:120px; text-align:center;">0, 0</div>
        <button id="authBtn" style="background:#400000; color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer;">Admin</button>
    </div>
</div>

<div id="adminSidePanel">
  <div class="panel-section"><div class="section-title">Valtaus</div><button id="confirmAreaBtn" class="tool-btn" style="background:#1b5e20;">TALLENNA RUUTU</button><div style="display:flex; gap:5px; flex-wrap:wrap; margin-top:5px;" id="colorPicker"></div></div>
  <div class="panel-section">
    <div class="section-title">Ruudukko & Kalibrointi</div>
    <div style="display:flex; justify-content: space-between;"><input type="number" id="targetX" class="coord-input" value="1700"><input type="number" id="targetY" class="coord-input" value="3700"></div>
    <button id="syncCoordsBtn" class="tool-btn" style="background:#e67e22; color:#000;">‚öôÔ∏è ASETA RUUTUUN</button>
    <button id="gridMoveBtn" class="tool-btn">‚ñ¶ SIIRTO</button>
    <input type="range" id="gsSlider" min="10" max="100" value="25" style="width:100%; margin-top:10px;">
    <div style="text-align:center; font-size:10px; color:#888;">RUUDUN KOKO: <span id="gsVal">25px</span></div>
  </div>
  <div class="panel-section">
      <div class="section-title">Markkerit</div>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
          <button class="m-selector tool-btn" data-type="green">üåø Kasvi paikka</button>
          <button class="m-selector tool-btn" data-type="orange">üî• Kasvaa</button>
          <button class="m-selector tool-btn" data-type="yellow">üçç Kasvaa</button>
      </div>
      <button class="m-selector tool-btn" data-type="erase">‚ùå Poista</button>
  </div>
  <button id="pushBtn" class="tool-btn" style="background:#4a148c; border-color:#9c27b0;">PUSH v2.3.2</button>
</div>

<canvas id="map"></canvas>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

  const firebaseConfig = { apiKey: "AIzaSyDNRDRwOQEnNDVeFIZe4no7wvOdHnpyfvY", authDomain: "hellcity-jengi-map.firebaseapp.com", projectId: "hellcity-jengi-map", databaseURL: "https://hellcity-jengi-map-default-rtdb.europe-west1.firebasedatabase.app" };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const dataRef = ref(db, 'live_map');
  const canvas = document.getElementById('map');
  const ctx = canvas.getContext('2d');

  const CURRENT_VERSION = "v2.3.2";

  let userLoggedIn = false, gridMoveMode = false, markerMode = "none", capturedAreas = {}, freeMarkers = {}, gridOffset = {x:0, y:0}, scale = 0.15, offsetX = 0, offsetY = 0, lastMouse = {x:0, y:0}, isDragging = false, isDraggingGrid = false, selectedGrid = {gx:null, gy:null}, currentColor = "rgba(0, 255, 0, 0.5)", GRID_SIZE = 25, bX = 1700, bY = 3700, hoverMarker = null;

  onAuthStateChanged(auth, u => { userLoggedIn = !!u; document.getElementById('mainBody').classList.toggle('is-admin', userLoggedIn); document.getElementById('authBtn').innerText = userLoggedIn ? "Ulos" : "Admin"; });
  document.getElementById('doLogin').onclick = () => { signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPass').value).then(() => document.getElementById('loginOverlay').style.display='none').catch(() => alert("Virhe!")); };
  document.getElementById('authBtn').onclick = () => userLoggedIn ? signOut(auth) : document.getElementById('loginOverlay').style.display='flex';

  const tiles = []; let loadedTiles = 0;
  for (let y = 0; y < 8; y++) { for (let x = 0; x < 8; x++) { const img = new Image(); img.src = `gta_karttapalat/tile_${x}_${y}.png`; img.onload = () => { if(++loadedTiles === 64) { centerMap(); draw(); } }; tiles.push({ img, x, y }); } }
  function centerMap() { offsetX = (window.innerWidth/2)-(4096*scale); offsetY = (window.innerHeight/2)-(4096*scale); }
  function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=>t.style.display='none',3000); }
  function getCoords(gx, gy) { return { x: Math.round(bX + (gx * 100)), y: Math.round(bY - (gy * 100)) }; }

  function draw() {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    ctx.save(); ctx.translate(offsetX, offsetY); ctx.scale(scale, scale);
    ctx.imageSmoothingEnabled = false;
    tiles.forEach(t => ctx.drawImage(t.img, t.x * 1024, t.y * 1024, 1025, 1025));
    
    if (gridMoveMode) {
        ctx.beginPath(); ctx.strokeStyle = "rgba(255, 165, 0, 0.4)"; ctx.lineWidth = 1/scale;
        for (let x = -2000; x <= 10000; x += GRID_SIZE) { ctx.moveTo(x + gridOffset.x, -2000); ctx.lineTo(x + gridOffset.x, 10000); }
        for (let y = -2000; y <= 10000; y += GRID_SIZE) { ctx.moveTo(-2000, y + gridOffset.y); ctx.lineTo(10000, y + gridOffset.y); }
        ctx.stroke();
    }

    for (let key in capturedAreas) { let [gx, gy] = key.split(',').map(Number); ctx.fillStyle = capturedAreas[key].color; ctx.fillRect(gx*GRID_SIZE + gridOffset.x, gy*GRID_SIZE + gridOffset.y, GRID_SIZE, GRID_SIZE); }
    for (let id in freeMarkers) {
        const m = freeMarkers[id]; let emoji = ""; let col = "";
        const hoursPassed = (Date.now() - m.createdAt) / 3600000;
        if (m.type === "orange") { if (hoursPassed >= 14) { emoji = "‚úÖ"; col = "#2ecc71"; } else { emoji = "üî•"; col = "#e67e22"; } } else { emoji = "üåø"; col = "#27ae60"; }
        ctx.fillStyle = col; ctx.beginPath(); ctx.arc(m.x, m.y, 12/scale, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "white"; ctx.lineWidth = 1/scale; ctx.stroke();
        ctx.font = `${16/scale}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(emoji, m.x, m.y);
        if (m.type === "yellow") { if (hoursPassed >= 5) { emoji = "‚úÖ"; col = "#2ecc71"; } else { emoji = "üçç"; col = "#e67e22"; } } else { emoji = "üåø"; col = "#27ae60"; }
        ctx.fillStyle = col; ctx.beginPath(); ctx.arc(m.x, m.y, 12/scale, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = "white"; ctx.lineWidth = 1/scale; ctx.stroke();
        ctx.font = `${16/scale}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(emoji, m.x, m.y);
    }
    if (selectedGrid.gx !== null) { ctx.strokeStyle = "white"; ctx.lineWidth = 3/scale; ctx.strokeRect(selectedGrid.gx*GRID_SIZE + gridOffset.x, selectedGrid.gy*GRID_SIZE + gridOffset.y, GRID_SIZE, GRID_SIZE); }
    ctx.restore();

    if (hoverMarker) {
        const now = Date.now();
        const created = hoverMarker.createdAt;
        const diffMs = (created + (14 * 3600000)) - now;
        const date = new Date(created);
        const timeStr = `Luotu: ${date.toLocaleDateString('fi-FI')} klo ${date.toLocaleTimeString('fi-FI', { hour: '2-digit', minute: '2-digit' })}`;
        ctx.font = "bold 13px Segoe UI";
        let lines = [];
        if (hoverMarker.type === "orange" && diffMs > 0) {
            const h = Math.floor(diffMs / 3600000); const m = Math.floor((diffMs % 3600000) / 60000);
            lines.push(`Valmis: ${h}h ${m}m`);
        }
        lines.push(timeStr);
        const padding = 10; const lineHeight = 18;
        let maxWidth = 0; lines.forEach(l => { maxWidth = Math.max(maxWidth, ctx.measureText(l).width); });
        ctx.fillStyle = "rgba(0,0,0,0.95)"; ctx.strokeStyle = "#ff0000"; ctx.lineWidth = 2;
        const boxW = maxWidth + (padding * 2); const boxH = (lines.length * lineHeight) + padding;
        ctx.fillRect(lastMouse.x + 15, lastMouse.y - 15, boxW, boxH);
        ctx.strokeRect(lastMouse.x + 15, lastMouse.y - 15, boxW, boxH);
        ctx.fillStyle = "#fff"; ctx.textAlign = "left"; ctx.textBaseline = "top";
        lines.forEach((line, i) => {
            ctx.fillStyle = (i === 0 && lines.length > 1) ? "#e67e22" : "#fff";
            ctx.fillText(line, lastMouse.x + 15 + padding, lastMouse.y - 15 + padding/2 + (i * lineHeight));
        });
    }
  }

  window.onmousemove = (e) => {
    const wx = (e.clientX - offsetX)/scale, wy = (e.clientY - offsetY)/scale;
    hoverMarker = null;
    for (let id in freeMarkers) { if (Math.hypot(freeMarkers[id].x - wx, freeMarkers[id].y - wy) < 15/scale) { hoverMarker = freeMarkers[id]; break; } }
    if (isDraggingGrid) { gridOffset.x += (e.clientX - lastMouse.x)/scale; gridOffset.y += (e.clientY - lastMouse.y)/scale; }
    else if (isDragging) { offsetX += e.clientX - lastMouse.x; offsetY += e.clientY - lastMouse.y; }
    lastMouse = {x:e.clientX, y:e.clientY}; draw();
  };

  canvas.onmousedown = (e) => {
    const wx = (e.clientX - offsetX)/scale, wy = (e.clientY - offsetY)/scale;
    if (e.button === 2) { isDragging = true; lastMouse = {x:e.clientX, y:e.clientY}; return; }
    if (gridMoveMode && userLoggedIn) { isDraggingGrid = true; lastMouse = {x:e.clientX, y:e.clientY}; return; }
    
    if (userLoggedIn && markerMode !== "none") {
        if(markerMode === "erase") { for(let id in freeMarkers) if(Math.hypot(freeMarkers[id].x-wx, freeMarkers[id].y-wy) < 20/scale) remove(ref(db, `live_map/free_markers/${id}`)); }
        else { push(ref(db, 'live_map/free_markers'), { x:wx, y:wy, type:markerMode, createdAt: Date.now() }); }
        return;
    }
    selectedGrid = { gx: Math.floor((wx-gridOffset.x)/GRID_SIZE), gy: Math.floor((wy-gridOffset.y)/GRID_SIZE) };
    const c = getCoords(selectedGrid.gx, selectedGrid.gy); document.getElementById('coords-val').innerText = `${c.x}, ${c.y}`; draw();
  };

  document.querySelectorAll('.m-selector').forEach(b => {
      b.onclick = () => {
          const type = b.dataset.type;
          if (markerMode === type) {
              markerMode = "none";
              b.classList.remove('active');
          } else {
              document.querySelectorAll('.m-selector').forEach(x => x.classList.remove('active'));
              b.classList.add('active');
              markerMode = type;
          }
      };
  });

  document.getElementById('syncCoordsBtn').onclick = () => { if(!userLoggedIn || selectedGrid.gx === null) return; bX = parseInt(document.getElementById('targetX').value) - (selectedGrid.gx * 100); bY = parseInt(document.getElementById('targetY').value) + (selectedGrid.gy * 100); update(ref(db, 'live_map'), { base_x: bX, base_y: bY }); showToast("Kalibroitu!"); draw(); };
  document.getElementById('gridMoveBtn').onclick = () => { gridMoveMode = !gridMoveMode; document.getElementById('gridMoveBtn').classList.toggle('active', gridMoveMode); draw(); };
  document.getElementById('confirmAreaBtn').onclick = () => { if(selectedGrid.gx === null) return; const key = `${selectedGrid.gx},${selectedGrid.gy}`; currentColor === "erase" ? remove(ref(db, `live_map/areas/${key}`)) : set(ref(db, `live_map/areas/${key}`), { color: currentColor }); showToast("Tallennettu!"); };
  window.onwheel = (e) => { const f = Math.pow(1.1, e.deltaY > 0 ? -1 : 1); const wx = (e.clientX - offsetX) / scale; const wy = (e.clientY - offsetY) / scale; scale = Math.min(Math.max(scale * f, 0.04), 5); offsetX = e.clientX - wx * scale; offsetY = e.clientY - wy * scale; draw(); };
  window.onmouseup = () => { if(isDraggingGrid) update(ref(db, 'live_map'), { offset: gridOffset }); isDragging = isDraggingGrid = false; };
  
  const colors = ["rgba(0, 255, 0, 0.5)", "rgba(255, 0, 0, 0.5)", "rgba(0, 100, 255, 0.5)", "rgba(255, 255, 0, 0.5)", "rgba(160, 32, 240, 0.5)", "erase"];
  colors.forEach(c => { const s = document.createElement('div'); s.className = 'swatch'; s.style.background = (c==='erase'?'#444':c); s.onclick = () => { document.querySelectorAll('.swatch').forEach(w=>w.classList.remove('active')); s.classList.add('active'); currentColor = c; }; document.getElementById('colorPicker').appendChild(s); });
  
  document.getElementById('pushBtn').onclick = () => { update(ref(db, 'live_map'), { version: CURRENT_VERSION }); showToast("Push " + CURRENT_VERSION + "!"); };

  onValue(dataRef, (s) => {
    const d = s.val() || {}; capturedAreas = d.areas || {}; freeMarkers = d.free_markers || {}; gridOffset = d.offset || {x:0, y:0};
    if(d.base_x !== undefined) bX = d.base_x; if(d.base_y !== undefined) bY = d.base_y;
    if(d.current_grid_size) { GRID_SIZE = d.current_grid_size; document.getElementById('gsSlider').value = GRID_SIZE; document.getElementById('gsVal').innerText = GRID_SIZE+"px"; }
    if(d.version && d.version !== CURRENT_VERSION) document.getElementById('versionWarning').style.display = 'block'; else document.getElementById('versionWarning').style.display = 'none';
    document.getElementById('areaCount').innerText = Object.keys(capturedAreas).length;
    if(d.version) document.getElementById('verLabel').innerText = d.version; draw();
  });
  window.onresize = () => draw();
  canvas.oncontextmenu = (e) => e.preventDefault();
</script>
</body>
</html>



